---
title: "Project 7: Difference-in-Differences and Synthetic Control"
output:
  html_document: default
---


```{r}
# Install and load packages 
if (!require("pacman")) install.packages("pacman")

devtools::install_github("ebenmichael/augsynth")

pacman::p_load(# Tidyverse packages including dplyr and ggplot2 
               tidyverse,
               ggthemes,
               augsynth,
               gsynth)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
# set seed
set.seed(44)

# load data
medicaid_expansion <- read_csv("data/medicaid_expansion.csv")
colnames(medicaid_expansion)
```

# Introduction

For this project, you will explore the question of whether the Affordable Care Act increased health insurance coverage (or conversely, decreased the number of people who are uninsured). The ACA was passed in March 2010, but several of its provisions were phased in over a few years. The ACA instituted the "individual mandate" which required that all Americans must carry health insurance, or else suffer a tax penalty. There are four mechanisms for how the ACA aims to reduce the uninsured population:

- Require companies with more than 50 employees to provide health insurance.
- Build state-run healthcare markets ("exchanges") for individuals to purchase health insurance.
- Provide subsidies to middle income individuals and families who do not qualify for employer based coverage.
- Expand Medicaid to require that states grant eligibility to all citizens and legal residents earning up to 138\% of the federal poverty line. The federal government would initially pay 100\% of the costs of this expansion, and over a period of 5 years the burden would shift so the federal government would pay 90\% and the states would pay 10\%.

In 2012, the Supreme Court heard the landmark case NFIB v. Sebelius, which principally challenged the constitutionality of the law under the theory that Congress could not institute an individual mandate. The Supreme Court ultimately upheld the individual mandate under Congress's taxation power, but struck down the requirement that states must expand Medicaid as impermissible subordination of the states to the federal government. Subsequently, several states refused to expand Medicaid when the program began on January 1, 2014. This refusal created the "Medicaid coverage gap" where there are indivudals who earn too much to qualify for Medicaid under the old standards, but too little to qualify for the ACA subsidies targeted at middle-income individuals.

States that refused to expand Medicaid principally cited the cost as the primary factor. Critics pointed out however, that the decision not to expand primarily broke down along partisan lines. In the years since the initial expansion, several states have opted into the program, either because of a change in the governing party, or because voters directly approved expansion via a ballot initiative.

You will explore the question of whether Medicaid expansion reduced the uninsured population in the U.S. in the 7 years since it went into effect. To address this question, you will use difference-in-differences estimation, and synthetic control.

# Data

The dataset you will work with has been assembled from a few different sources about Medicaid. The key variables are:

- **State**: Full name of state
- **Medicaid Expansion Adoption**: Date that the state adopted the Medicaid expansion, if it did so.
- **Year**: Year of observation.
- **Uninsured rate**: State uninsured rate in that year.

# Exploratory Data Analysis

Create plots and provide 1-2 sentence analyses to answer the following questions:

- Which states had the highest uninsured rates prior to 2014? The lowest?
- Which states were home to most uninsured Americans prior to 2014? How about in the last year in the data set? **Note**: 2010 state population is provided as a variable to answer this question. In an actual study you would likely use population estimates over time, but to simplify you can assume these numbers stay about the same.



```{r}
# Highest and lowest uninsured rates
#Find years in dataset
unique(medicaid_expansion$year)
# Filter data for all years prior to 2014
pre2014_data <- medicaid_expansion %>%
  filter(year < 2014)

# Uninsured rates prior to 2014 (Going to take the mean of all years prior, not taking it year by year, will update if this is a mistake)
pre2014_uninsuredrate <- pre2014_data %>%
  group_by(State) %>%
  summarize(mean_uninsured_rate = mean(uninsured_rate)) %>%
  arrange(desc(mean_uninsured_rate)) %>%
  mutate(State = factor(State, levels = State)) 

#Find top and bottom quartiles (calling this the highest and lowest, since I don't want to plot all 50 states)
# Calculate the 25th and 75th percentiles (Quartiles)
q1 <- quantile(pre2014_uninsuredrate$mean_uninsured_rate, 0.25)
q3 <- quantile(pre2014_uninsuredrate$mean_uninsured_rate, 0.75)

# Filter states in the bottom and top quartiles based on mean uninsured rate
bottom_quartile2014 <- pre2014_uninsuredrate %>%
  filter(mean_uninsured_rate <= q1) %>%
  mutate(Quartile = 'Bottom Quartile')

top_quartile2014 <- pre2014_uninsuredrate %>%
  filter(mean_uninsured_rate >= q3) %>%
  mutate(Quartile = 'Top Quartile')

# Combine both quartiles into a single data frame
combined_quartiles <- bind_rows(bottom_quartile2014, top_quartile2014)

# Create a plot for both top and bottom quartiles
ggplot(combined_quartiles, aes(x = reorder(State, mean_uninsured_rate), y = mean_uninsured_rate, fill = Quartile)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(title = 'States with the Highest and Lowest Uninsured Rates Prior to 2014', 
       x = 'State', 
       y = 'Mean Uninsured Rate (%)') +
  scale_fill_manual(values = c('Bottom Quartile' = 'lightgreen', 'Top Quartile' = 'lightcoral')) +
  theme_minimal()

```
I decided to plot uninsured population rates pre-2014 as an average of those rates over the pre-2014 years in the study period (2008-2013). I understand that I lose some naunce here because rates could be way higher/lower at some point in this pre-2014 period leading to a deceiving average, whereas looking at this yearly would allow me to see those trends over time pre-2014, but for the sake of exploratory analyses, I like this visual. I will return to this if it seems like later on I should be looking year to year. It looks like the states with the lowest rates of uninsured individuals pre-2014 are mostly northern/midwestern states, and the highest rates of uninsured individuals are southern/western states. P.S., it's noted that D.C. is missing population data. If that becomes an issue, I'll take it out of the dataset.

```{r}
library(dplyr)
# most uninsured Americans
# Calculate total uninsured population for each state prior to 2014 
pre2014_uninsuredrate <- pre2014_data %>%
  group_by(State) %>%
  summarize(
    mean_uninsured_rate = mean(uninsured_rate),
    population = first(population)  #Since there's only one unique value for each state (because it's based on 2010 population), just choosing the first
  ) %>%
  mutate(
    total_uninsured_population = population * mean_uninsured_rate
  ) %>%
  arrange(desc(total_uninsured_population)) %>%
  mutate(State = factor(State, levels = State))

#Caluclate total uninsured population for each state in 2020
uninsured_2020 <- medicaid_expansion %>%
  filter(year == 2020) %>%
  group_by(State) %>%
  summarize(
    uninsured_rate_2020 = first(uninsured_rate),  # Use the uninsured rate directly for 2020
    population = first(population)  # Use the population for the state
  ) %>%
  mutate(
    total_uninsured_population_2020 = population * uninsured_rate_2020
  ) %>%
  arrange(desc(total_uninsured_population_2020))
glimpse(pre2014_uninsuredrate)
glimpse(uninsured_2020)
```


```{r}
# Filter states in the top quartiles pre-2014 and in 2020 based on total uninsured population rates
library(ggplot2)
library(scales)  # for comma format
library (tidyr)
#Define cutoffs
q3_2014 <- quantile(pre2014_uninsuredrate$total_uninsured_population, 0.75, na.rm = TRUE)
q3_2020 <- quantile(uninsured_2020$total_uninsured_population_2020, 0.75, na.rm = TRUE)

#Filter states in the top quartile for both time periods 
pre2014_top <- pre2014_uninsuredrate %>%
  mutate(Year = "Pre-2014") %>%
  mutate(in_top_quartile_2014 = total_uninsured_population >= q3_2014) %>%
  select(State, total_uninsured_population_2014 = total_uninsured_population, in_top_quartile_2014)

post2020_top <- uninsured_2020 %>%
  mutate(Year = "2020") %>%
  mutate(in_top_quartile_2020 = total_uninsured_population_2020 >= q3_2020) %>%
  select(State, total_uninsured_population_2020, in_top_quartile_2020)

# Full join on State to preserve all states that were in either top quartile
combined_all_states <- full_join(pre2014_top, post2020_top, by = "State")

# Filter out states that weren't in the top quartile for either time period
combined_all_states <- combined_all_states %>%
  filter(in_top_quartile_2014 == TRUE | in_top_quartile_2020 == TRUE)

# Reformat data for plotting 
plot_data <- combined_all_states %>%
  pivot_longer(cols = starts_with("total_uninsured_population"),
               names_to = "Year",
               values_to = "total_uninsured_population") %>%
  mutate(Year = recode(Year,
                       "total_uninsured_population_2014" = "Pre-2014",
                       "total_uninsured_population_2020" = "2020"))

# Create a plot for both top quartiles, adding the data for a state if it was in the top quartile for either time period 
ggplot(plot_data, aes(x = reorder(State, -total_uninsured_population, na.rm = TRUE),
                      y = total_uninsured_population,
                      fill = Year)) +
  geom_bar(stat = "identity", position = "dodge", na.rm = TRUE) +
  labs(title = "Top Quartile States (Pre2014 and/or 2020) by Total Uninsured Population",
       x = "State",
       y = "Total Uninsured Population") +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
It looks like the total population of uninsured people went down from pre-2014 levels for all states in 2020. California seems to have a huge difference, Florida and New York too, and then Texas looks like it didn't change that much. It's important to note that the graph includes states that were in the top quartile of total uninsured individuals for either pre-2014 or in 2020, so some of these states might not have been in the top quartile for both time periods.



# Difference-in-Differences Estimation

## Estimate Model

Do the following:

- Choose a state that adopted the Medicaid expansion on January 1, 2014 and a state that did not. **Hint**: Do not pick Massachusetts as it passed a universal healthcare law in 2006, and also avoid picking a state that adopted the Medicaid expansion between 2014 and 2015.
- Assess the parallel trends assumption for your choices using a plot. If you are not satisfied that the assumption has been met, pick another state and try again (but detail the states you tried).

```{r}
#Find out when states adopted medicaid expansion, create a column indicating whether or not state ever adopted  
medicaid_adoption <- medicaid_expansion %>%
  distinct(State, Date_Adopted) %>%
  mutate(
    Adopted = ifelse(is.na(Date_Adopted), "Never Expanded", "Expanded")
  ) %>%
  arrange(Date_Adopted)

#Merge with dataset
medicaid_expansion$Date_Adopted <- as.Date(medicaid_expansion$Date_Adopted)
medicaid_adoption$Date_Adopted <- as.Date(medicaid_adoption$Date_Adopted)
medicaid_expansion_full <- medicaid_expansion %>%
  left_join(medicaid_adoption %>% select(State, Date_Adopted, Adopted), by = "State") %>%
  select(-Date_Adopted.x) %>%
  rename(Date_Adopted = Date_Adopted.y)
colnames(medicaid_expansion_full)
```

```{r}
#When it says "choose a state that did not" I'm assuming this means choose a state that never adopted the expansion, not a state that adopted the expansion just not between 2014-205 (e.g. 2020)
#Find states that adopted expansion on 1/1/2014 and those who didn't at all, create a new dataframe to work on 
compare_states <- medicaid_expansion_full %>%
  filter(Date_Adopted == as.Date("2014-01-01") | Adopted == "Never Expanded")
compare_states <- compare_states %>%
  left_join(pre2014_uninsuredrate %>%
              select(State, total_uninsured_population, mean_uninsured_rate),
            by = "State")

```
I had such a hard time trying to figure out how to show parallel trends lol. As I've griped about in class, I feel like parallel trends are pretty unconvincing, it's pretty easy for me to think something fails the eye test unless the lines are, like, really similar. 

```{r}
#Parallel trends plot
parallel_data <- compare_states %>%
  filter(State %in% c("California", "Georgia")) %>%
  select(State, year, uninsured_rate)

parallel_data <- parallel_data %>%
  mutate(year = as.integer(year))

ggplot(parallel_data, aes(x = year, y = uninsured_rate, color = State)) +
  geom_line(size = 1.2) +
  geom_point() +
  scale_x_continuous(breaks = seq(min(parallel_data$year), 2014, 1),
                     labels = as.character(seq(min(parallel_data$year), 2014, 1))) +
  coord_cartesian(xlim = c(min(parallel_data$year), 2014)) +  # truncate the plot at 2014
  labs(title = "Pre-2014 Uninsured Rate Trends: California vs. Georgia",
       x = "Year",
       y = "Uninsured Rate",
       color = "State") +
  theme_minimal()
```

```{r}
#Find two states, one that never adopted the expansion and one that adopted 1/1/2014 that are similar in terms of uninsured_rates, populations, and total_uninsured populations prior to 2014
compare_states %>%
  filter(State %in% c("California", "Georgia")) %>%
  distinct(State, population, Date_Adopted, mean_uninsured_rate, total_uninsured_population) %>%
  print()

```
This was the best I could do... the parallel trends look visually the best out of any pair I tested (I spent like an hour and a half trying), but I know obviously that there are reasons to believe that Georgia and California are very different. That being said, when weighing the visual parallel trends vs. our real world knowledge of these policy contexts, which is important? For example, I kept trying jurisdictions that seemed similar enough (Kentucky vs. Alabama) but their parallel trends visually just couldn't be justified to me. Not sure if this was the better move or if I should've picked a "worse" trend visually that made more sense in the real world.


- Estimates a difference-in-differences estimate of the effect of the Medicaid expansion on the uninsured share of the population. You may follow the lab example where we estimate the differences in one pre-treatment and one post-treatment period, or take an average of the pre-treatment and post-treatment outcomes

```{r}
# Difference-in-Differences estimation
#Create dataframe
cg <- compare_states %>%
  filter(State %in% c("California", "Georgia")) %>%
  filter(year %in% c(2013, 2014))

#Pre-treatment difference
pre_diff <- cg %>%
  filter(year == 2013) %>%
  select(State, uninsured_rate) %>%
  pivot_wider(names_from = State, values_from = uninsured_rate) %>%
  summarise(diff = California - Georgia)
#post-treatment diference
post_diff <- cg %>%
  filter(year == 2014) %>%
  select(State, uninsured_rate) %>%
  pivot_wider(names_from = State, values_from = uninsured_rate) %>%
  summarise(diff = California - Georgia)

#DiD
diff_in_diffs <- post_diff - pre_diff
diff_in_diffs
```
I think this means that California's uninsured rate went down by -0.01648 from the pre-treatment year (2013) to the post-treatment year (2014). 

## Discussion Questions

- Card/Krueger's original piece utilized the fact that towns on either side of the Delaware river are likely to be quite similar to one another in terms of demographics, economics, etc. Why is that intuition harder to replicate with this data?
Like discussed above, the trade-off between choosing two states whose parallel trend lines are more convincing and ones whose policy context seem similar is actually more difficult than one might imagine; as we saw above, places with seemingly similar policy contexts (neighboring states with similar populations and mean rates of uninsured population) often had really wonky parallel trends that were often thrown off by just one year. Maybe it's not even fair to assume that geographically neighboring or similar (e.g. comparing two midwestern states) states would have similar policy contexts, but it definitely seems more intuitive that Georgia is more similar to Florida than it is to California. But I think that would be the intuition of Card/Krueger that can't be applied here; two neighboring towns are probably more likely to be similar than two neighboring states, but even that feels like a stretch. Two towns that are split by some geographical feature might have differences - see the construction of highways in Oakland. Even though I think Card/Krueger's paper was two different states (if I remember this discussion right), two towns that share a border in two states is a different scale than we're looking at.

- What are the strengths and weaknesses of using the parallel trends assumption in difference-in-differences estimates?
I think the strength is how powerful the visual aspect of parallel trends is. Even though it is subjective, if you see two lines that basically have the same exact slope,it's hard to argue with that. My California/Georgia example may not be the best, but if it were a little better visually, the existence of the parallel trends visually will kind of rebut claims that these places are too different to compare. Meaning, if the outcome of interest is trending in the same exact ways in these two places, it seems likely that no matter how different they are, covariates are seemingly impacting them in the same way. I think the weakness for me, as mentioned, is also the visual aspect and the fact that it is not really a mathematical formulation of "parallelness," like there's no universal standard, it's just sort of a visual thing that your reviewers may or may not be convinced by. I guess the upshot of that is anyone who is doing serious diff-in-diff work probably is really good at defending their analytical choices to stave off criticisms for those who are typically unconvinced by parallel trends!


# Synthetic Control

Estimate Synthetic Control

Although several states did not expand Medicaid on January 1, 2014, many did later on. In some cases, a Democratic governor was elected and pushed for a state budget that included the Medicaid expansion, whereas in others voters approved expansion via a ballot initiative. The 2018 election was a watershed moment where several Republican-leaning states elected Democratic governors and approved Medicaid expansion. In cases with a ballot initiative, the state legislature and governor still must implement the results via legislation. For instance, Idaho voters approved a Medicaid expansion in the 2018 election, but it was not implemented in the state budget until late 2019, with enrollment beginning in 2020.

Do the following:

- Choose a state that adopted the Medicaid expansion after January 1, 2014. Construct a non-augmented synthetic control and plot the results (both pre-treatment fit and post-treatment differences). Also report the average ATT and L2 imbalance.



```{r}
# non-augmented synthetic control
#Find delayed adopters
adopted_post2014 <- medicaid_expansion_full %>%
  filter(Date_Adopted > as.Date("2014-12-31")) %>%
  distinct(State, Date_Adopted)

view(adopted_post2014)
#I'm not sure if I should be using some theory-informed state for the synthetic control, but my gut is telling me to pick a state that adopted on New Years day of some year. Earlier in the notebook it said don't choose 2014 or 2015 for DiD, so I won't choose either. Therefore, I'll choose 01-01-2016 as my date, which hopefully will still give me enough data post-treatment.
#Redoing this all to take out treatment states
treated_state <- "Montana"
treatment_year <- medicaid_expansion_full %>%
  filter(State == treated_state) %>%
  pull(Date_Adopted) %>%
  unique() %>%
  as.Date() %>%
  format("%Y") %>%
  as.numeric()

# Identify states that never expanded Medicaid (proper controls)
# Flag for the proper donors (control states)
never_expanded_states <- medicaid_expansion_full %>%
  filter(is.na(Date_Adopted)) %>%  # Only keep states that never adopted
  distinct(State) %>%
  pull(State)

medicaid_clean <- medicaid_expansion_full %>%
  mutate(
    treatment = ifelse(State == "Montana" & year >= 2016, 1, 0),
    is_proper_donor = State %in% never_expanded_states
  )

# Run non-augmented synthetic control
syn <- augsynth(
  uninsured_rate ~ treatment,  # Outcome variable and treatment indicator
  unit = State,                # Unit (states)
  time = year,                 # Time variable (year)
  data = medicaid_clean,       # Data frame
  progfunc = "none",           # No augmentation
  scm = TRUE                   # Enable synthetic control
)


#Save ATT and L2 imbalance
# Extract the ATT and L2 Imbalance from the summary text (I was having issues with getting the ATT out of the summary)
summary_text <- capture.output(summary(syn))
att_line <- summary_text[grep("Average ATT Estimate", summary_text)]
l2_line <- summary_text[grep("L2 Imbalance", summary_text)]

# Extract the numeric values for ATT and L2 Imbalance
non_aug_att <- as.numeric(str_extract(att_line, "[-]?\\d+\\.\\d+"))
non_aug_l2 <- as.numeric(str_extract(l2_line, "[-]?\\d+\\.\\d+"))

# Print out the results
cat("Non-Augmented ATT:", non_aug_att, "\n")
cat("Non-Augmented L2 Imbalance:", non_aug_l2, "\n")
```


```{r}
weights_df <- data.frame(syn$weights) %>%
  tibble::rownames_to_column('State') %>%
  rename(syn_weight = syn.weights)

# Plot weights
library(ggplot2)
library(ggthemes)

ggplot(weights_df) +
  geom_col(aes(x = State, y = syn_weight), fill = "steelblue") +
  coord_flip() +
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) +
  labs(
    title = "Non-Augmented Synthetic Control Weights",
    x = "State",
    y = "Weight"
  )
```
Okay, only a few states are donors (is that the right terminology?) for our synthetic control. It looks like Alaska, Nevada, South Dakota, and Wisconsin are our donor states but like the class notebook, lets look closer at the ones that actually contribtued. Is it a problem that Alaska's contribution is so outsized?

```{r}
# view each state's contribution, where weights are greater than 0
# ---------
data.frame(syn$weights) %>%
  # processing
  # ---------
  tibble::rownames_to_column('State') %>%
  filter(syn.weights > 0) %>% # filter out weights less than 0
  # plot
  # ---------
  ggplot() +
  geom_bar(aes(x = State, 
               y = syn.weights),
           stat = 'identity') +
  coord_flip() +   # flip to make it more readable
  # themes
  theme_fivethirtyeight() +
  theme(axis.title = element_text()) +
  # labels
  ggtitle('Non- Augmented Synthetic Control Weights') +
  xlab('State') +
  ylab('Weight')
```

Yeah so it's Alaska, Nevada, South Dakota, Utah (couldn't see that ont eh first graph) and West Virginia. Interesting I guess, I have no sort of domain knowledge of why this might be the case.


- Re-run the same analysis but this time use an augmentation (default choices are Ridge, Matrix Completion, and GSynth). Create the same plot and report the average ATT and L2 imbalance.

```{r}
# augmented synthetic control
# Filter the data to only include Montana and never-expanded states (if you can't tell, Kasey, I'm redoing this after I first ran the ridge with little success - I was using everything as possible donors)
filtered_data <- medicaid_clean %>% 
  filter(State == "Montana" | State %in% never_expanded_states)

# Then run augsynth
ridge_syn <- augsynth(
  uninsured_rate ~ treatment, 
  State,
  year, 
  filtered_data,
  progfunc = "ridge",
  scm = TRUE
)
# Extract the ATT and L2 Imbalance using the same approach as before (same issue getting ATT)
summary_aug_text <- capture.output(summary(ridge_syn))
aug_att_line <- summary_aug_text[grep("Average ATT Estimate", summary_aug_text)]
aug_l2_line <- summary_aug_text[grep("L2 Imbalance", summary_aug_text)]

# Extract the numeric values
aug_att <- as.numeric(str_extract(aug_att_line, "[-]?\\d+\\.\\d+"))
aug_l2 <- as.numeric(str_extract(aug_l2_line, "[-]?\\d+\\.\\d+"))

# Print out the results
cat("Non-Augmented ATT:", non_aug_att, "\n")
cat("Augmented ATT:", aug_att, "\n")
cat("Augmented L2 Imbalance:", aug_l2, "\n")
cat("Non-Augmented L2 Imbalance (for comparison):", non_aug_l2, "\n")
```
Um, so it actually seems like our ridge L2 imbalance is worse than our non-augmented L2 imbalance. But at the same time, the ridge ATT is more negative than the non-augmented synthetic control, suggesting a more negative effect of medicaid expansion on uninsured rates. So the ridge seems to worsen the pre-treatment balance, it estimated a larger treatment effect. I'm unclear where this leaves me - which metric takes priority - I'm assuming it's the L2 over the ATT.
- Plot barplots to visualize the weights of the donors.

```{r}
# barplots of weights
weights_plot <- data.frame(ridge_syn$weights) %>% 
  tibble::rownames_to_column('State') %>% 
  filter(ridge_syn.weights > 0) %>% 
  ggplot() + 
  geom_bar(aes(x = reorder(State, ridge_syn.weights), y = ridge_syn.weights), 
           stat = 'identity', fill = "steelblue") + 
  coord_flip() + 
  theme_minimal() + 
  labs(
    title = "Ridge Synthetic Control Weights", 
    x = "State", 
    y = "Weight"
  )

print(weights_plot)
```
**HINT**: Is there any preprocessing you need to do before you allow the program to automatically find weights for donor states?
Oh...I guess I thought I could use states that had a different treatment time but I think the donors have to be untreated?
YAY earlier I was getting that only Nevada was a donor state. I feel like in class we talked about negative weights and that they're not a bad thing (because I had asked this question assuming negative is bad), and the 6-6 notebook also has negative weights in the ridge synthetic control, but it's not inherently a bad thing that my ridge doesn't have negative weights, right?
```{r}
# Create a comparison plot between actual, non-aug synthetic, and ridge Montana
# Get the summary objects for both syn and aug_syn
syn_sum <- summary(syn)
aug_syn_sum <- summary(ridge_syn)

# Create a dataset for Montana actual values
montana_actual <- medicaid_clean %>%
  filter(State == "Montana")

# Now create a new dataframe that combines all three lines
montana_comparison <- montana_actual %>%
  select(year, uninsured_rate) %>%
  # Add columns for synthetic values and augmented synthetic values
  mutate(
    synthetic_montana = NA_real_,
    ridge_synthetic_montana = NA_real_
  )

# We need to populate the synthetic values for the years where we have estimates
# Extract the years and estimates from the summary objects
syn_years <- syn_sum$att$Time
syn_estimates <- syn_sum$att$Estimate

aug_syn_years <- aug_syn_sum$att$Time
aug_syn_estimates <- aug_syn_sum$att$Estimate

# Now fill in the synthetic values for the years we have data
for (i in 1:length(syn_years)) {
  year_match <- syn_years[i]
  if (year_match %in% montana_comparison$year) {
    # For a given year, the synthetic value is the actual value minus the estimate
    # (since estimate = actual - synthetic)
    montana_row <- which(montana_comparison$year == year_match)
    actual_value <- montana_comparison$uninsured_rate[montana_row]
    montana_comparison$synthetic_montana[montana_row] <- actual_value - syn_estimates[i]
  }
}

# Do the same for augmented synthetic
for (i in 1:length(aug_syn_years)) {
  year_match <- aug_syn_years[i]
  if (year_match %in% montana_comparison$year) {
    montana_row <- which(montana_comparison$year == year_match)
    actual_value <- montana_comparison$uninsured_rate[montana_row]
    montana_comparison$ridge_synthetic_montana[montana_row] <- actual_value - aug_syn_estimates[i]
  }
}

# Now create the plot
montana_comparison %>%
  ggplot() +
  # Montana actual line
  geom_line(aes(x = year, 
                y = uninsured_rate, 
                color = 'Montana'), size = 1) +
  # Synthetic Montana line
  geom_line(aes(x = year, 
                y = synthetic_montana, 
                color = 'Synthetic Montana'), size = 1) +
  # Ridge Synthetic Montana line
  geom_line(aes(x = year, 
                y = ridge_synthetic_montana, 
                color = 'Ridge Synthetic Montana'), size = 1) +
  # Color scale
  scale_color_manual(values = c('Montana' = 'red', 
                              'Synthetic Montana' = 'blue',
                              'Ridge Synthetic Montana' = 'green')) +
  # Add vertical line at treatment year (2016)
  geom_vline(aes(xintercept = 2016)) +
  # Theming
  theme_fivethirtyeight() +
  theme(axis.title = element_text(),
        legend.position = "bottom",
        legend.title = element_blank()) +
  # Labels
  ggtitle('Montana, Synthetic Montana, and Ridge Synthetic Montana') +
  xlab('Year') +
  ylab('Uninsured Rate')
```
YAY before my ridge and my non-augmented synthetic were exactly the same but now we can see that they're different, with the actual Montana having the lowest rates of unisured people post-treatment, followed by the synthetic and then the ridge having the highest. I guess alarming is the fact that pretreatment, observed rates of uninsured people dropped a lot in real life right before the treatment whereas both ridge and non-auugmented synthetic didn't drop so dramatically right before treatment, so maybe that indicates that phenomenon we talked about in class (anticipation bias, maybe it was called?) where people know a treatment is coming and act accordingly. We also see that dip in 2010 in observed Montana whereas ridge and non-augmented synthetic isn't so severe, so again maybe that is an instance in which real historical events in Montana impacted rates of uninsured people in ways that the models can't necessarily account for. I'm also confused how this can be the results when the ATT score was more negative for the ridge.

## Discussion Questions


- What are the advantages and disadvantages of synthetic control compared to difference-in-differences estimators?
- **Answer**: 
Well we already talked about the pros and cons of diff-in-diff (or at least my biased opinion), but I sort of think of synthetic control like the more ideal version of diff-and-diff. By that I mean that diff-and-diff and synthetic control both have similar aims - to try and estimate what the counterfactual would be without treatment, but whereas diff-and-diff is in some ways more intuitive, synthetic control requires a lot more work in order to construct the counterfactual. In some ways that's an upshot, since it takes out some of the guess work that we saw is required of diff-and-diff, but in some ways, like in my notebook, we can see the downsides of having to make these choices. For example, various different choices that I made impacted the synthetic control results both for the non and augmented versions. The states included, the penalties, the type of augmentation, these all impact the results in a way that is less self-evident unless you're playing around with the different choices like I did here. 

- One of the benefits of synthetic control is that the weights are bounded between [0,1] and the weights must sum to 1. Augmentation might relax this assumption by allowing for negative weights. Does this create an interpretation problem, and how should we balance this consideration against the improvements augmentation offers in terms of imbalance in the pre-treatment period?
- **Answer**:
Well I (unfortunately?) did not have that issue here, but yes, I think intuitively that seems like it would create an interpretation problem. If synthetic control weights must sum to 1, but we have negative weights, it's harder to understand what it means to contribute to the model. Like it is intutive to me that a positive weight is contributing to the model, but it is less intutive how a negative weight contributes in the same way. With respect to the fact that augmentation improves imbalance (again, didn't happen for me lol), from this question I am inferring that the lessened imbalance that comes from the possibility of negative weights in the augmented model comes at the expense of the interpretibility of the non-augmented synthetic control that (is supposed to) has more pre-treatment imbalance than an augmented one. 

# Staggered Adoption Synthetic Control

## Estimate Multisynth

Do the following:

- Estimate a multisynth model that treats each state individually. Choose a fraction of states that you can fit on a plot and examine their treatment effects.

```{r}
# multisynth model states
# Prepare data for multisynth 
medicaid_multi_ready <- medicaid_expansion_full %>%
  # Create binary treatment indicator based on adoption year
  mutate(
    cbr = ifelse(!is.na(Date_Adopted) & year >= as.numeric(format(Date_Adopted, "%Y")), 1, 0)
  )

# Run multisynth with default nu
# ---------
ppool_syn <- multisynth(uninsured_rate ~ cbr, 
                        State,                        # unit
                        year,                         # time
                        medicaid_multi_ready,         # data 
                        n_leads = 6)                  # post-treatment periods to estimate

# View results 
print(ppool_syn$nu)

# Get summary stats
# ---------
ppool_syn_summ <- summary(ppool_syn)

# Calculate average treatment effect for each state
state_effects <- ppool_syn_summ$att %>%
  filter(Level != "Average") %>%
  group_by(Level) %>%
  summarize(
    avg_effect = mean(Estimate, na.rm = TRUE)
  ) %>%
  arrange(avg_effect)  # Sort by effect size

# Get the top weights from the non-aug synthetic control
top_contributors <- data.frame(syn$weights) %>%
  tibble::rownames_to_column('State') %>%
  filter(syn.weights > 0) %>%
  arrange(desc(syn.weights)) %>%
  head(8) %>%  # Take top 8 states with highest weights
  pull(State)

# Create a focused plot with just Montana, top contributors, and Average
focused_states <- c("Montana", top_contributors, "Average")

# Create a more readable plot with fewer states
ppool_syn_summ$att %>%
  filter(Level %in% focused_states) %>%
  # Restrict to dataset timre range
  filter(Time >= -6 & Time <= 6) %>%  # Show 6 years before to 6 years after expansion
  ggplot(aes(x = Time, y = Estimate, color = Level)) +
  geom_point() +
  geom_line(size = 1) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dotted", color = "gray50") +
  theme_fivethirtyeight() +
  theme(axis.title = element_text(),
        legend.position = "bottom",
        legend.title = element_blank()) +
  ggtitle('Treatment Effects: Montana vs. Top Synthetic Control Donors') +
  xlab('Time Relative to Expansion') +
  ylab('Effect on Uninsured Rate')
```
Cool, so this is showing me the average treatment effects for the top donor states of my non-augmented synthetic control vs. Montana. I wish I wasn't colorblind, but I think Montana is kind of in the middle there, but has a larger negative ATT than the average, and I think our top donor was Alaska, which has a more positive ATT than Montana at most points. 

- Estimate a multisynth model using time cohorts. For the purpose of this exercise, you can simplify the treatment time so that states that adopted Medicaid expansion within the same year (i.e. all states that adopted epxansion in 2016) count for the same cohort. Plot the treatment effects for these time cohorts.

```{r}
# multisynth model time cohorts
# Create cohorts directly from the adoption dates
medicaid_cohorts <- medicaid_expansion_full %>%
  # Create a treatment indicator based on adoption date
  mutate(
    # Extract just the year from the date for cohort grouping (I can't believe I didn't have to do this earlier in the notebook)
    cohort_year = case_when(
      is.na(Date_Adopted) ~ NA_real_,  # Never expanded
      TRUE ~ as.numeric(format(Date_Adopted, "%Y"))
    ),
    # Create treatment indicator
    cbr = ifelse(!is.na(Date_Adopted) & year >= cohort_year, 1, 0)
  )

# Run multisynth with these time cohorts
ppool_syn_time <- multisynth(uninsured_rate ~ cbr, 
                           State,
                           year,
                           medicaid_cohorts,
                           n_leads = 6,
                           time_cohort = TRUE)

# Get summary stats
ppool_syn_time_summ <- summary(ppool_syn_time)

# Plot with facets
ppool_syn_time_summ$att %>%
  # Filter to a reasonable time range
  filter(Time >= -6 & Time <= 6) %>%
  ggplot(aes(x = Time, y = Estimate, color = Level)) +
  geom_point() +
  geom_line(size = 1) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dotted", color = "gray50") +
  theme_fivethirtyeight() +
  theme(axis.title = element_text(),
        legend.position = 'None') +
  ggtitle('Medicaid Expansion Effects by Adoption Year Cohort') +
  xlab('Time Relative to Expansion') +
  ylab('Effect on Uninsured Rate') +
  facet_wrap(~Level)
```
What is most concerning to me is that for all of the cohorts, there is a pretty significant drop right before treatment time (0). So is this indicating that the effect we're seeing might not be from the expansion itself, but from something that seems to be coming before the expansion? 
## Discussion Questions

- One feature of Medicaid is that it is jointly administered by the federal government and the states, and states have some flexibility in how they implement Medicaid. For example, during the Trump administration, several states applied for waivers where they could add work requirements to the eligibility standards (i.e. an individual needed to work for 80 hours/month to qualify for Medicaid). Given these differences, do you see evidence for the idea that different states had different treatment effect sizes?
- **Answer**: 
Hm that's interesting because I've mainly been looking at time rather than the attributes of individual states throughout this project, but I guess we can see in the first multisynth regarding donors that if we're normalizing time, that there are still differences in ATT between states. So yes, I guess that would indicate that different states have different treatment effect sizes. But in retrospect, I probably should have looked at both geograhy and time rather than thinking mostly about time of expansion. 

- Do you see evidence for the idea that early adopters of Medicaid expansion enjoyed a larger decrease in the uninsured population?
- **Answer**: 
I mean kind of... I think we can see evidence of that in this last multisynth plot, but I guess I also think we would be cautious because look at the time horizons for effects for 2019 and 2020 (late adopters) vs the available data for the early adopting states. To be more confident, I think I would just want more data post-treatment for all cohorts to be sure. 

# General Discussion Questions

- Why are DiD and  synthetic control estimates well suited to studies of aggregated units like cities, states, countries, etc?
- **Answer**:
If I can recall back from class, I think we talked about the utility of having similar data/data collection across the same types of units, which is necessary to make the comparisons for Diff and diff and synthetic control. For example, in this study we're looking at state-level medicaid data, so (redundantly but importantly) we know this is being implemented at the level of the state, so that constant unit of analysis to study the treatment allows us to construct these comparisons, particularly in situations where there is variation, such as our staggered adoption. 

- What role does selection into treatment play in DiD/synthetic control versus regression discontinuity? When would we want to use either method?
- **Answer**:
We know that medicaid expansion can be impacted by states selecting into treatment (see the above example provided in one of the discussion question prompts) - the decision when, how, and if to expand medicaid is presumably related to the outcome of interest. This is the strength of thinking about pre-treatment trends and covariates, so that when we look at the effect that medicaid expansion has on rates of uninsured populations, we have constructed our counterfactuals to hopefully help us understand the impact that these observed/unobserved factors have relative to the treatment itself.
With regression discontinuity, we pick a cutoff point and look at the differences of those just above or just below the cutoff, with the assumption that these observations are similar such that whether or not they are in the treatment group is not due to differences in covariates - it is essentially as if it were random. That sort of "cutoff" logic doesn't really make sense in this context, that logic (and RD) makes more sense when we're thinking about something like test scores or income thresholds where we can get a sense of the formula of selection into treatment in order to determine a cutoff threshold. 